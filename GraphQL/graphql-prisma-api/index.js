// ApolloServer â†’ GraphQL ã‚µãƒ¼ãƒãƒ¼æœ¬ä½“ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
// gql â†’ GraphQL ã‚¹ã‚­ãƒ¼ãƒæ–‡å­—åˆ—ã‚’æ‰±ã„ã‚„ã™ãã™ã‚‹ï¼ˆå¾Œè¿°ï¼‰
const { ApolloServer, gql } = require('apollo-server');
// PrismaClient â†’ DB ã«å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
const { PrismaClient } = require('@prisma/client');

// Prisma Client ã®åˆæœŸåŒ–
const prisma = new PrismaClient();

// GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
// gql`ã€œ`ã®å†…éƒ¨ã¯GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹
// GraphQLã§ã¯schema.prismaã¨ã¯ç•°ãªã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§NULLè¨±å®¹ã«ãªã‚‹ãŸã‚ã€ã€Œå‹!ã€ã¨ã—ãªã„ã¨NOT NULLåˆ¶ç´„ãŒé©ç”¨ã•ã‚Œãªã„
// GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒã®ã†ã¡ã€Query ã¨ Mutation ã¯å¿…ãšå®šç¾©ã™ã‚‹å¿…è¦ãŒç‰¹åˆ¥ãªçµ„ã¿è¾¼ã¿å‹S
const typeDefs = gql`
  type User {
    id: Int!
    name: String!
    email: String!
  }

  # ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®æ“ä½œï¼ˆèª­ã¿å–ã‚Šï¼‰
  # [User]   â†’ é…åˆ—ï¼ˆãƒªã‚¹ãƒˆï¼‰ã‚’è¿”ã™ ã“ã¨ã‚’ç¤ºã™
  # [User!]  â†’ é…åˆ—ã®ä¸­ã® å„è¦ç´ ãŒ NULL ã§ãªã„ã“ã¨ã‚’ä¿è¨¼  â€»é…åˆ—ã®é•·ã•ãŒ 0 ã§ã‚‚ OKï¼ˆç©ºé…åˆ—ã¯è¨±ã•ã‚Œã‚‹ï¼‰
  # [User!]! â†’ é…åˆ—ã®ä¸­ã® å„è¦ç´ ãŒ NULL ã§ãªã„ã“ã¨ã‚’ä¿è¨¼ã—ã€ç©ºé…åˆ—ã‚‚è¨±ã•ã‚Œãªã„
  type Query {
    users: [User!]!
  }

  # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ç”¨ã®æ“ä½œï¼ˆæ›¸ãè¾¼ã¿ï¼‰
  type Mutation {
    createUser(name: String!, email: String!): User!
  }
`;

// Resolver â†’ ã‚¯ã‚¨ãƒªã‚„ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã‚’å®šç¾©ã™ã‚‹
const resolvers = {
  Query: {
    // async () => {...} éåŒæœŸé–¢æ•°ã¨ã—ã¦å®šç¾©
    users: async () => {
      // prisma.user.findMany()
      //     prisma     â†’ PrismaClient ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
      //     user       â†’ chema.prisma å†…ã®ãƒ¢ãƒ‡ãƒ«å User ã«å¯¾å¿œï¼ˆPrisma Client ã§ã¯ãƒ¢ãƒ‡ãƒ«åã®å…ˆé ­ã‚’å°æ–‡å­—ã«ã—ãŸã‚‚ã®ãŒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦ä½œã‚‰ã‚Œã‚‹ï¼‰ 
      //     findMany() â†’ éåŒæœŸé–¢æ•°ã§ã€DBã‹ã‚‰æ¡ä»¶ã«åˆè‡´ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å…¨ä»¶å–å¾—ã—ã¦é…åˆ—ã¨ã—ã¦è¿”ã™
      // await â†’ éåŒæœŸé–¢æ•°ã®çµæœã‚’å¾…ã¤
      return await prisma.user.findMany();
    },
  },
  Mutation: {
    // async (_, args) => {...} 
    //     _    â†’ ç¬¬ä¸€å¼•æ•°ã¯ã€è¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä»Šå›ã¯ä½¿ç”¨ã—ãªã„ï¼‰
    //     args â†’ ç¬¬äºŒå¼•æ•°ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¸¡ã•ã‚ŒãŸå¼•æ•°ã‚’å—ã‘å–ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹åª’ä½“ï¼‰
    createUser: async (_, args) => {
      // args ã‹ã‚‰å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–ã‚Šå‡ºã™
      const { name, email } = args;
      // prisma.user.create()
      //     prisma      â†’ PrismaClient ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
      //     user        â†’ chema.prisma å†…ã®ãƒ¢ãƒ‡ãƒ«å User ã«å¯¾å¿œï¼ˆPrisma Client ã§ã¯ãƒ¢ãƒ‡ãƒ«åã®å…ˆé ­ã‚’å°æ–‡å­—ã«ã—ãŸã‚‚ã®ãŒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦ä½œã‚‰ã‚Œã‚‹ï¼‰ 
      //     create()    â†’ éåŒæœŸé–¢æ•°ã§ã€DBã«æ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦è¿”ã™
      //     data: {...} â†’ ä½œæˆã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆschema.prisma ã§å®šç¾©ã—ãŸãƒ¢ãƒ‡ãƒ«ã®ã‚«ãƒ©ãƒ ã‚’æŒ‡å®šå¯ï¼‰
      // await â†’ éåŒæœŸé–¢æ•°ã®çµæœã‚’å¾…ã¤
      return await prisma.user.create({
        data: { name, email },
      });
    },
  },
};

// Apollo Server åˆæœŸåŒ–
// GraphQL ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€typeDefs ã¨ resolvers ã‚’ä½¿ã£ã¦å‡¦ç†ã‚’è¿”ã™ã‚µãƒ¼ãƒãƒ¼æœ¬ä½“ã‚’ä½œæˆ
// ã‚‚ã— GraphQL ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ node.js ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ä½¿ç”¨ã—ã¦ã„ãªã„ï¼ˆGraphQLå°‚ç”¨ï¼‰
const server = new ApolloServer({ typeDefs, resolvers });

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
server.listen().then(({ url }) => {
  console.log(`ğŸš€ Server ready at ${url}`);
});
